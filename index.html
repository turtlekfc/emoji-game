<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji æ¶ç­”æ­£å¼ç‰ˆ</title>
    <style>
        :root { --p: #46178f; --a: #ffa600; }
        body { font-family: sans-serif; background: var(--p); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; }
        .card { background: white; color: #333; padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; }
        .hidden { display: none !important; }
        .emoji-box { font-size: 70px; margin: 20px 0; min-height: 100px; line-height: 100px; }
        input { padding: 12px; width: 80%; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; }
        button { background: var(--a); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="debug-info" style="position:fixed; top:0; font-size:10px; color:#aaa;">Loading JS...</div>

    <div class="card">
        <div id="view-login">
            <h2>ğŸ‘€ Emoji è«§éŸ³å¤§è³½</h2>
            <input type="text" id="username" placeholder="è¼¸å…¥å§“å">
            <button id="btn-join">åŠ å…¥</button>
        </div>

        <div id="view-waiting" class="hidden">
            <h3>æ‚¨å¥½ <span id="display-name"></span></h3>
            <p>ç­‰å¾…ä¸»æŒäººé–‹å•Ÿ...</p>
            <div id="host-ctrl" class="hidden" style="border-top: 1px solid #eee; padding: 10px;">
                <button id="btn-start">é–‹å§‹éŠæˆ²</button>
            </div>
        </div>

        <div id="view-game" class="hidden">
            <div id="q-info"></div>
            <div id="q-emoji" class="emoji-box"></div>
            <div id="player-zone">
                <input type="text" id="ans-input" placeholder="ç­”æ¡ˆï¼Ÿ">
                <button id="btn-submit">é€å‡º</button>
                <p id="msg" style="color:red;"></p>
            </div>
            <div id="ans-reveal" class="hidden">
                <h2 id="correct-ans" style="color:blue;"></h2>
                <p id="winner-name"></p>
            </div>
            <div id="host-actions" class="hidden">
                <button id="btn-reveal">æ­æ›‰</button>
                <button id="btn-next" class="hidden">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <div id="view-result" class="hidden">
            <h2>ğŸ† æœ€çµ‚æ’è¡Œ</h2>
            <div id="leaderboard"></div>
            <button onclick="location.reload()">é‡ç©</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, runTransaction, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        document.getElementById('debug-info').innerText = "JS Loaded. Connecting Firebase...";

        const firebaseConfig = {
            apiKey: "AIzaSyAGKM7UL7hYCijHzS7lbPuHi-2M8Y9gZ7U",
            authDomain: "kahootclone-94620.firebaseapp.com",
            databaseURL: "https://kahootclone-94620-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kahootclone-94620",
            storageBucket: "kahootclone-94620.appspot.com",
            messagingSenderId: "173514871128",
            appId: "1:173514871128:web:6ca8ccb012ba5a49b7d52d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const urlParams = new URLSearchParams(window.location.search);
        const isHost = urlParams.get('host') === 'true';
        let myName = "";

        document.getElementById('debug-info').innerText = "Firebase Connected. Mode: " + (isHost ? "Host" : "Player");

        const questions = [
            { emoji: "ğŸ² â™¨ï¸", answer: "é¾æ½­" }, { emoji: "5ï¸âƒ£â›°ï¸", answer: "äº”å³°" }, { emoji: "ğŸ”Ÿ0ï¸âƒ£0ï¸âƒ£0ï¸âƒ£ğŸŒ¸", answer: "è¬è¯" },
            { emoji: "ğŸª‘æ©‹", answer: "æ¿æ©‹" }, { emoji: "ğŸ†•ğŸ ", answer: "æ–°å±‹" }, { emoji: "ğŸ†•ğŸ›’", answer: "æ–°åº—" },
            { emoji: "3ï¸âƒ£â›°ï¸", answer: "ä¸‰å³½" }, { emoji: "ğŸ¥‡â›°ï¸", answer: "é‡‘å±±" }, { emoji: "5ï¸âƒ£ğŸ¦´", answer: "äº”è‚¡" },
            { emoji: "7ï¸âƒ£ğŸš§", answer: "ä¸ƒå µ" }, { emoji: "ğŸ’â›°ï¸", answer: "å¯¶å±±" }, { emoji: "ğŸ¦ â™¨ï¸", answer: "ç…æ½­" },
            { emoji: "â¬‡ï¸âš“", answer: "å—æ¸¯" }, { emoji: "ğŸ˜ğŸ¤°", answer: "å¤§è‚š" }, { emoji: "ğŸ¦Œâš“", answer: "é¹¿æ¸¯" }
        ];

        function goTo(id) {
            document.querySelectorAll('.card > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        document.getElementById('btn-join').onclick = () => {
            myName = document.getElementById('username').value.trim();
            if(!myName) return alert("è«‹è¼¸å…¥å§“å");
            document.getElementById('display-name').innerText = myName;
            goTo('view-waiting');
            if(isHost) {
                document.getElementById('host-ctrl').classList.remove('hidden');
                remove(ref(db, 'game'));
            }
        };

        document.getElementById('btn-start').onclick = () => {
            const shuffled = questions.sort(() => 0.5 - Math.random()).slice(0, 10);
            set(ref(db, 'game'), { status: 'playing', qs: shuffled, idx: 0, winner: "", show: false });
        };

        onValue(ref(db, 'game'), (snap) => {
            const game = snap.val();
            if(!game) return;
            if(game.status === 'playing') {
                goTo('view-game');
                const cur = game.qs[game.idx];
                document.getElementById('q-info').innerText = `ç¬¬ ${game.idx + 1} é¡Œ`;
                document.getElementById('q-emoji').innerText = cur.emoji;
                if(game.winner) {
                    document.getElementById('player-zone').classList.add('hidden');
                    if(isHost) {
                        document.getElementById('host-actions').classList.remove('hidden');
                        document.getElementById('btn-next').classList.toggle('hidden', !game.show);
                    }
                    if(game.show) {
                        document.getElementById('ans-reveal').classList.remove('hidden');
                        document.getElementById('correct-ans').innerText = "ç­”æ¡ˆï¼š" + cur.answer;
                        document.getElementById('winner-name').innerText = "è´å®¶ï¼š" + game.winner;
                    }
                } else {
                    document.getElementById('player-zone').classList.remove('hidden');
                    document.getElementById('ans-reveal').classList.add('hidden');
                    document.getElementById('host-actions').classList.add('hidden');
                }
            } else if(game.status === 'finished') {
                goTo('view-result');
                onValue(ref(db, 'players'), (pSnap) => {
                    const ps = pSnap.val();
                    let list = [];
                    for(let k in ps) list.push({n: k, s: ps[k]});
                    list.sort((a,b) => b.s - a.s);
                    document.getElementById('leaderboard').innerHTML = list.map(p => `<div>${p.n}: ${p.s}</div>`).join('');
                }, { onlyOnce: true });
            }
        });

        document.getElementById('btn-submit').onclick = () => {
            const input = document.getElementById('ans-input').value.trim();
            onValue(ref(db, 'game'), (snap) => {
                const game = snap.val();
                if(input === game.qs[game.idx].answer && !game.winner) {
                    update(ref(db, 'game'), { winner: myName });
                    runTransaction(ref(db, `players/${myName}`), (s) => (s || 0) + 10);
                } else if(input !== game.qs[game.idx].answer) {
                    document.getElementById('msg').innerText = "å†è©¦è©¦ï¼";
                }
            }, { onlyOnce: true });
        };

        document.getElementById('btn-reveal').onclick = () => update(ref(db, 'game'), { show: true });
        document.getElementById('btn-next').onclick = () => {
            onValue(ref(db, 'game'), (snap) => {
                const game = snap.val();
                if(game.idx + 1 < game.qs.length) {
                    update(ref(db, 'game'), { idx: game.idx + 1, winner: "", show: false });
                } else {
                    update(ref(db, 'game'), { status: 'finished' });
                }
            }, { onlyOnce: true });
        };
    </script>
</body>
</html>