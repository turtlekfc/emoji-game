<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji æ¶ç­”å¤§è³½ - çµ‚æ¥µç©©å®šç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #46178f; --accent: #ffa600; --bg: #f4f4f9; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--primary); color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .card { background: white; color: #333; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); text-align: center; }
        .hidden { display: none !important; }
        .emoji-large { font-size: 80px; margin: 20px 0; display: block; min-height: 120px; line-height: 120px; }
        input[type="text"], input[type="number"] { padding: 15px; font-size: 1.2rem; width: 85%; border: 2px solid #ddd; border-radius: 10px; margin: 10px 0; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; padding: 15px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 10px; cursor: pointer; transition: 0.3s; margin: 10px; }
        button:hover { transform: scale(1.05); }
        .instruction-box { background: #eee; padding: 15px; border-radius: 10px; text-align: left; font-size: 0.9rem; line-height: 1.6; margin-bottom: 15px; }
        #debug-info { position: fixed; top: 10px; left: 10px; font-size: 12px; color: rgba(255,255,255,0.5); z-index: 999; }
        #leaderboard { margin-top: 20px; text-align: left; }
        .lb-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

    <div id="debug-info">ç­‰å¾…è…³æœ¬è¼‰å…¥...</div>

    <div class="card">
        <div id="view-login">
            <h2>ğŸ‘€ Emoji è«§éŸ³å¤§è³½</h2>
            <div class="instruction-box">
                <b>éŠæˆ²èªªæ˜ï¼š</b><br>
                çœ‹åœ–çŒœå°ç£åœ°åï¼ğŸ‘€ å¯èƒ½æ˜¯çœ¼ã€çœ‹ã€ç›®ã€æœ›...<br>
                ç¯„ä¾‹ï¼šğŸ‘€ğŸµ â” <b>è§€éŸ³</b> | â¬‡ï¸ğŸ˜ï¸ â” <b>å—åº„</b>
            </div>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            <button id="btn-join">é€²å…¥éŠæˆ²</button>
        </div>

        <div id="view-waiting" class="hidden">
            <h3>æ‚¨å¥½ï¼Œ<span id="display-name"></span>ï¼</h3>
            <p>ç­‰å¾…ä¸»æŒäººé–‹å•Ÿé¡Œç›®...</p>
            <div id="host-ctrl" class="hidden" style="border-top: 2px solid #eee; padding-top: 20px; margin-top:20px; background:#f9f0ff; border-radius:10px;">
                <p style="color: #46178f; font-weight: bold;">[ ä¸»æŒäººæ§åˆ¶å° ]</p>
                <label>æŠ½é¡Œæ•¸é‡ï¼š</label>
                <input type="number" id="q-count" value="10" min="1" max="35" style="width: 70px;"><br>
                <button id="btn-start">æ­£å¼é–‹å§‹æ¶ç­”</button>
            </div>
        </div>

        <div id="view-game" class="hidden">
            <div id="q-header" style="font-weight: bold; color: #666;">è¼‰å…¥ä¸­...</div>
            <div id="q-emoji" class="emoji-large"></div>
            
            <div id="player-zone">
                <input type="text" id="ans-input" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ">
                <button id="btn-submit">é€å‡ºç­”æ¡ˆ</button>
                <div id="feedback" style="color:red; margin-top:10px; font-weight:bold;"></div>
            </div>

            <div id="win-zone" class="hidden">
                <div style="font-size: 1.5rem; color: #28a745; font-weight: bold;">ğŸ‰ æ‚¨æ¶åˆ°é€™é¡Œäº†ï¼</div>
                <p>è«‹ç­‰ä¸»æŒäººåˆ‡æ›...</p>
            </div>

            <div id="ans-reveal" class="hidden" style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 10px;">
                <h2 id="correct-ans-text" style="color: blue; margin: 5px 0;"></h2>
                <p>æœ¬é¡Œå¾—ä¸»ï¼š<span id="winner-name-display" style="font-weight: bold; color: green;"></span></p>
            </div>

            <div id="host-actions" class="hidden" style="margin-top:20px; border-top: 1px solid #ccc; padding-top:10px;">
                <button id="btn-reveal" style="background:#28a745;">æ­æ›‰ç­”æ¡ˆ</button>
                <button id="btn-next" class="hidden" style="background:#46178f;">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <div id="view-result" class="hidden">
            <h2>ğŸ† æœ€çµ‚æ’è¡Œ</h2>
            <div id="leaderboard"></div>
            <button onclick="location.reload()">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script>
        const debug = document.getElementById('debug-info');
        
        // 1. Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAGKM7UL7hYCijHzS7lbPuHi-2M8Y9gZ7U",
            authDomain: "kahootclone-94620.firebaseapp.com",
            databaseURL: "https://kahootclone-94620-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kahootclone-94620",
            storageBucket: "kahootclone-94620.appspot.com",
            messagingSenderId: "173514871128",
            appId: "1:173514871128:web:6ca8ccb012ba5a49b7d52d"
        };

        // 2. åˆå§‹åŒ–
        try {
            firebase.initializeApp(firebaseConfig);
            var db = firebase.database();
            debug.innerText = "Firebase é€£ç·šæˆåŠŸ";
        } catch (e) {
            debug.innerText = "é€£ç·šå¤±æ•—: " + e.message;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const isHost = urlParams.get('host') === 'true';
        let myName = "";

        // 3. å®Œæ•´é¡Œåº«
        const questions = [
            { emoji: "ğŸ² â™¨ï¸", answer: "é¾æ½­" }, { emoji: "5ï¸âƒ£â›°ï¸", answer: "äº”å³°" }, { emoji: "ğŸ”Ÿ0ï¸âƒ£0ï¸âƒ£0ï¸âƒ£ğŸŒ¸", answer: "è¬è¯" },
            { emoji: "ğŸª‘æ©‹", answer: "æ¿æ©‹" }, { emoji: "ğŸ†•ğŸ ", answer: "æ–°å±‹" }, { emoji: "ğŸ†•ğŸ›’", answer: "æ–°åº—" },
            { emoji: "3ï¸âƒ£â›°ï¸", answer: "ä¸‰å³½" }, { emoji: "ğŸ¥‡â›°ï¸", answer: "é‡‘å±±" }, { emoji: "5ï¸âƒ£ğŸ¦´", answer: "äº”è‚¡" },
            { emoji: "7ï¸âƒ£ğŸš§", answer: "ä¸ƒå µ" }, { emoji: "ğŸ’â›°ï¸", answer: "å¯¶å±±" }, { emoji: "ğŸ¦ â™¨ï¸", answer: "ç…æ½­" },
            { emoji: "â¬‡ï¸âš“", answer: "å—æ¸¯" }, { emoji: "ğŸ˜ğŸ¤°", answer: "å¤§è‚š" }, { emoji: "ğŸ¦Œâš“", answer: "é¹¿æ¸¯" },
            { emoji: "2ï¸âƒ£ğŸŒ²", answer: "äºŒæ—" }, { emoji: "2ï¸âƒ£ğŸ’§", answer: "äºŒæ°´" }, { emoji: "ğŸ‹â›°ï¸", answer: "ç«¹å±±" },
            { emoji: "4ï¸âƒ£â™¨ï¸", answer: "å››æ¹–" }, { emoji: "ğŸ˜ğŸŒ²", answer: "å¤§æ—" }, { emoji: "ğŸ†•âš“", answer: "æ–°æ¸¯" },
            { emoji: "6ï¸âƒ£ğŸ¦µ", answer: "å…­è…³" }, { emoji: "ğŸ¦ŒğŸŒ±", answer: "é¹¿è‰" }, { emoji: "ğŸ§‚ğŸ’§", answer: "é¹½æ°´" },
            { emoji: "3ï¸âƒ£ğŸ§‘â€ğŸ¤â€ğŸ§‘", answer: "ä¸‰æ°‘" }, { emoji: "ğŸš©â›°ï¸", answer: "æ——å±±" }, { emoji: "6ï¸âƒ£ğŸ¢", answer: "å…­é¾œ" },
            { emoji: "â¡ï¸âš“", answer: "æ±æ¸¯" }, { emoji: "â™¾ï¸ğŸŒ¸", answer: "æ†æ˜¥" }, { emoji: "ğŸ¦", answer: "ç…å­" },
            { emoji: "ğŸŒº", answer: "ç‰¡ä¸¹" }, { emoji: "3ï¸âƒ£â­", answer: "ä¸‰æ˜Ÿ" }, { emoji: "ğŸ˜âš”ï¸", answer: "å¤§æ­¦" },
            { emoji: "7ï¸âƒ£ ğŸ§œ", answer: "ä¸ƒç¾" }
        ];

        function goTo(id) {
            document.querySelectorAll('.card > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // ç™»å…¥é‚è¼¯
        document.getElementById('btn-join').onclick = function() {
            myName = document.getElementById('username').value.trim();
            if(!myName) return alert("è«‹è¼¸å…¥å§“å");
            document.getElementById('display-name').innerText = myName;
            goTo('view-waiting');
            if(isHost) {
                document.getElementById('host-ctrl').classList.remove('hidden');
                db.ref('game').remove(); // ä¸»æŒäººé€²å…¥è‡ªå‹•é‡ç½®
            }
        };

        // é–‹å§‹éŠæˆ²
        document.getElementById('btn-start').onclick = function() {
            const count = parseInt(document.getElementById('q-count').value) || 10;
            const shuffled = questions.sort(function() { return 0.5 - Math.random(); }).slice(0, count);
            db.ref('game').set({
                status: 'playing',
                qs: shuffled,
                idx: 0,
                winner: "",
                show: false
            });
        };

        // è³‡æ–™åŒæ­¥
        db.ref('game').on('value', function(snap) {
            const game = snap.val();
            if(!game) return;

            if(game.status === 'playing') {
                goTo('view-game');
                const cur = game.qs[game.idx];
                document.getElementById('q-header').innerText = "ç¬¬ " + (game.idx + 1) + " é¡Œ / å…± " + game.qs.length + " é¡Œ";
                document.getElementById('q-emoji').innerText = cur.emoji;

                if(game.winner) {
                    document.getElementById('player-zone').classList.add('hidden');
                    document.getElementById('win-zone').classList.toggle('hidden', game.winner !== myName);
                    if(isHost) {
                        document.getElementById('host-actions').classList.remove('hidden');
                        if(game.show) document.getElementById('btn-next').classList.remove('hidden');
                        else document.getElementById('btn-next').classList.add('hidden');
                    }
                    if(game.show) {
                        document.getElementById('ans-reveal').classList.remove('hidden');
                        document.getElementById('correct-ans-text').innerText = "ç­”æ¡ˆï¼š" + cur.answer;
                        document.getElementById('winner-name-display').innerText = game.winner;
                    }
                } else {
                    document.getElementById('player-zone').classList.remove('hidden');
                    document.getElementById('win-zone').classList.add('hidden');
                    document.getElementById('ans-reveal').classList.add('hidden');
                    document.getElementById('host-actions').classList.add('hidden');
                    document.getElementById('ans-input').value = "";
                    document.getElementById('feedback').innerText = "";
                }
            } else if(game.status === 'finished') {
                goTo('view-result');
                db.ref('players').once('value', function(pSnap) {
                    const ps = pSnap.val();
                    let list = [];
                    for(let k in ps) list.push({n: k, s: ps[k]});
                    list.sort(function(a, b) { return b.s - a.s; });
                    document.getElementById('leaderboard').innerHTML = list.map(function(p) {
                        return '<div class="lb-item"><span>' + p.n + '</span><span>' + p.s + ' åˆ†</span></div>';
                    }).join('');
                });
            }
        });

        // æ¶ç­”
        document.getElementById('btn-submit').onclick = function() {
            const input = document.getElementById('ans-input').value.trim();
            db.ref('game').once('value', function(snap) {
                const game = snap.val();
                if(input === game.qs[game.idx].answer && !game.winner) {
                    db.ref('game/winner').transaction(function(current) {
                        if (!current) {
                            db.ref('players/' + myName).transaction(function(s) { return (s || 0) + 10; });
                            return myName;
                        }
                        return current;
                    });
                } else if(input !== game.qs[game.idx].answer) {
                    document.getElementById('feedback').innerText = "âŒ ç­”éŒ¯å›‰ï¼";
                }
            });
        };

        // ç®¡ç†å“¡æ“ä½œ
        document.getElementById('btn-reveal').onclick = function() { db.ref('game/show').set(true); };
        document.getElementById('btn-next').onclick = function() {
            db.ref('game').once('value', function(snap) {
                const game = snap.val();
                if(game.idx + 1 < game.qs.length) {
                    db.ref('game').update({ idx: game.idx + 1, winner: "", show: false });
                } else {
                    db.ref('game/status').set('finished');
                }
            });
        };
    </script>
</body>
</html>