<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji æ¶ç­”å¤§è³½</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #6c5ce7; --accent: #fdcb6e; --danger: #ff7675; --success: #55efc4; }
        
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: radial-gradient(circle, #6c5ce7 0%, #4834d4 100%);
            color: white; margin: 0; padding: 20px 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; 
        }

        .header-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .event-logo { width: 50px; height: 50px; object-fit: contain; }
        .event-title { 
            font-size: 2.5rem; font-weight: 900; color: var(--accent); 
            text-shadow: 3px 3px 0px #d35400; margin: 0; letter-spacing: 2px;
        }

        .card { 
            background: white; color: #2d3436; padding: 30px; 
            border-radius: 30px; width: 90%; max-width: 500px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); border: 8px solid rgba(255,255,255,0.2);
            text-align: center;
        }

        .hidden { display: none !important; }
        .instruction-card { text-align: left; background: #f9f9f9; padding: 15px; border-radius: 15px; color: #444; line-height: 1.6; margin-bottom: 15px; }
        .qr-code { width: 200px; height: 200px; margin: 15px auto; display: block; border: 5px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .emoji-box { font-size: 80px; margin: 20px 0; min-height: 130px; display: flex; justify-content: center; align-items: center; background: #f1f2f6; border-radius: 20px; }
        
        input { padding: 12px; font-size: 1.1rem; width: 80%; margin: 10px 0; border: 3px solid #dfe6e9; border-radius: 12px; text-align: center; }
        
        button { 
            background: var(--accent); color: #d35400; border: none; 
            padding: 12px 25px; font-size: 1.1rem; border-radius: 50px; 
            cursor: pointer; font-weight: 900; box-shadow: 0 5px 0 #e67e22; margin: 10px;
        }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 #e67e22; }

        .host-fixed-tools {
            position: fixed; bottom: 15px; right: 15px;
            background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 15px;
            font-size: 0.8rem; display: flex; flex-direction: column; gap: 5px; z-index: 100;
        }
        .btn-danger-sm { background: var(--danger); font-size: 0.7rem; padding: 5px 10px; color: white; box-shadow: 0 3px 0 #c0392b; }

        .announcement { background: var(--success); color: #006266; padding: 15px; border-radius: 15px; margin: 15px 0; font-weight: bold; }
        
        /* æ’è¡Œæ¦œè¡¨æ ¼æ¨£å¼ */
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .lb-header { border-bottom: 2px solid var(--primary); color: var(--primary); font-weight: bold; }
        .lb-row { border-bottom: 1px solid #eee; }
        .lb-cell { padding: 12px 5px; font-size: 1.1rem; }
        .rank-badge { font-weight: 900; color: #636e72; }
        .top-1 { color: #f1c40f; font-size: 1.4rem; }
        .top-2 { color: #95a5a6; }
        .top-3 { color: #d35400; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="logo.png" alt="" class="event-logo" onerror="this.style.display='none'">
        <div class="event-title">æ´»å‹•åç¨±</div>
    </div>

    <div id="host-global-tools" class="host-fixed-tools hidden">
        <span>ğŸ‘‘ ç®¡ç†æ¬Šé™</span>
        <button onclick="hardResetGame()" class="btn-danger-sm">ğŸ”„ é‡ç½®éŠæˆ²</button>
    </div>

    <div class="card">
        <div id="view-login">
            <h2 style="color: var(--primary);">æ­¡è¿åƒåŠ æ¶ç­”ï¼</h2>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å">
            <button id="btn-join">ä¸‹ä¸€é </button>
        </div>

        <div id="view-setup" class="hidden">
            <h2 style="color: var(--primary);">éŠæˆ²è¨­å®š</h2>
            <p>è«‹è¨­å®šæŠ½å–é¡Œæ•¸ (1~34)ï¼š</p>
            <input type="number" id="q-count" value="10" min="1" max="34">
            <br>
            <button id="btn-to-instruction">ä¸‹ä¸€æ­¥ï¼šé€²å…¥èªªæ˜</button>
        </div>

        <div id="view-instruction" class="hidden">
            <h2 style="color: var(--primary);">éŠæˆ²èªªæ˜</h2>
            <div class="instruction-card">
                <b>ğŸ‘€ è¦å‰‡ï¼š</b>å¯èƒ½æ˜¯ã€Œçœ¼ã€ã€ã€Œç›ã€ã€ã€Œçœ‹ã€ã€ã€Œç›®ã€ã€ã€Œæœ›ã€...ç­‰çš„åŒéŸ³å­—ã€‚<br><br>
                <b>ğŸ’¡ ç¯„ä¾‹ï¼š</b><br>
                é¡Œç›®ï¼šğŸ‘€ğŸµ â” ç­”æ¡ˆï¼š<b>è§€éŸ³</b><br>
                é¡Œç›®ï¼šâ¬‡ï¸ğŸ˜ï¸ â” ç­”æ¡ˆï¼š<b>å—åº„</b>
            </div>
            <img src="qrcode.png" alt="åŠ å…¥éŠæˆ²" class="qr-code" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data='+window.location.href.split('?')[0]">
            <p id="wait-player-msg">è«‹å„ä½åƒè³½è€…æº–å‚™å°±ç·’...</p>
            <div id="host-start-btn" class="hidden">
                <button id="btn-real-start" style="background:var(--success); color:#006266; box-shadow:0 5px 0 #009432;">ğŸ® æ­£å¼é–‹å§‹æ¶ç­”ï¼</button>
            </div>
        </div>

        <div id="view-game" class="hidden">
            <div id="q-header" style="font-weight: bold;"></div>
            <div id="q-emoji" class="emoji-box"></div>
            <div id="player-zone" class="hidden">
                <input type="text" id="ans-input" placeholder="ç­”æ¡ˆæ˜¯ï¼Ÿ">
                <button id="btn-submit">é€å‡ºï¼</button>
                <p id="feedback" style="color:var(--danger); font-weight:bold;"></p>
            </div>
            <div id="win-notification" class="hidden">
                <div class="announcement">ğŸ‰ <span id="win-player-name"></span> æ¶åˆ°äº†ï¼</div>
            </div>
            <div id="ans-reveal" class="hidden" style="background:#e1f5fe; padding:15px; border-radius:20px;">
                <h3 style="margin:0;">æ­£è§£ï¼š<span id="correct-ans" style="color:#0288d1;"></span></h3>
            </div>
            <div id="host-actions" class="hidden">
                <button id="btn-reveal">æ­æ›‰ç­”æ¡ˆ</button>
                <button id="btn-next" class="hidden" style="background:var(--primary); color:white; box-shadow: 0 5px 0 #4834d4;">ä¸‹ä¸€é¡Œ â”</button>
            </div>
        </div>

        <div id="view-result" class="hidden">
            <h2 style="color:var(--primary);">ğŸ† æ¦®è­½æ’è¡Œæ¦œ</h2>
            <table class="lb-table">
                <thead>
                    <tr class="lb-header">
                        <td class="lb-cell">åæ¬¡</td>
                        <td class="lb-cell">ç©å®¶</td>
                        <td class="lb-cell">ç©åˆ†</td>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    </tbody>
            </table>
            <button id="btn-finish-reset" style="margin-top:30px; background:#dfe6e9; color:#636e72; box-shadow:0 5px 0 #b2bec3;">ğŸ”„ çµæŸä¸¦é‡ç½®éŠæˆ²</button>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyAGKM7UL7hYCijHzS7lbPuHi-2M8Y9gZ7U",
            authDomain: "kahootclone-94620.firebaseapp.com",
            databaseURL: "https://kahootclone-94620-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kahootclone-94620",
            storageBucket: "kahootclone-94620.appspot.com",
            messagingSenderId: "173514871128",
            appId: "1:173514871128:web:6ca8ccb012ba5a49b7d52d"
        };

        firebase.initializeApp(config);
        const db = firebase.database();
        const isHost = window.location.search.includes('host=true');
        let myName = "";

        const questions = [
            { emoji: "ğŸ² â™¨ï¸", answer: "é¾æ½­" }, { emoji: "5ï¸âƒ£â›°ï¸", answer: "äº”å³°" }, { emoji: "ğŸ”Ÿ0ï¸âƒ£0ï¸âƒ£0ï¸âƒ£ğŸŒ¸", answer: "è¬è¯" },
            { emoji: "ğŸª‘æ©‹", answer: "æ¿æ©‹" }, { emoji: "ğŸ†•ğŸ ", answer: "æ–°å±‹" }, { emoji: "ğŸ†•ğŸ›’", answer: "æ–°åº—" },
            { emoji: "3ï¸âƒ£â›°ï¸", answer: "ä¸‰å³½" }, { emoji: "ğŸ¥‡â›°ï¸", answer: "é‡‘å±±" }, { emoji: "5ï¸âƒ£ğŸ¦´", answer: "äº”è‚¡" },
            { emoji: "7ï¸âƒ£ğŸš§", answer: "ä¸ƒå µ" }, { emoji: "ğŸ’â›°ï¸", answer: "å¯¶å±±" }, { emoji: "ğŸ¦ â™¨ï¸", answer: "ç…æ½­" },
            { emoji: "â¬‡ï¸âš“", answer: "å—æ¸¯" }, { emoji: "ğŸ˜ğŸ¤°", answer: "å¤§è‚š" }, { emoji: "é¹¿ğŸ¦Œâš“", answer: "é¹¿æ¸¯" },
            { emoji: "2ï¸âƒ£ğŸŒ²", answer: "äºŒæ—" }, { emoji: "2ï¸âƒ£ğŸ’§", answer: "äºŒæ°´" }, { emoji: "ğŸ‹â›°ï¸", answer: "ç«¹å±±" },
            { emoji: "4ï¸âƒ£â™¨ï¸", answer: "å››æ¹–" }, { emoji: "ğŸ˜ğŸŒ²", answer: "å¤§æ—" }, { emoji: "ğŸ†•âš“", answer: "æ–°æ¸¯" },
            { emoji: "6ï¸âƒ£ğŸ¦µ", answer: "å…­è…³" }, { emoji: "ğŸ¦ŒğŸŒ±", answer: "é¹¿è‰" }, { emoji: "ğŸ§‚ğŸ’§", answer: "é¹½æ°´" },
            { emoji: "3ï¸âƒ£ğŸ§‘â€ğŸ¤â€ğŸ§‘", answer: "ä¸‰æ°‘" }, { emoji: "ğŸš©â›°ï¸", answer: "æ——å±±" }, { emoji: "6ï¸âƒ£ğŸ¢", answer: "å…­é¾œ" },
            { emoji: "â¡ï¸âš“", answer: "æ±æ¸¯" }, { emoji: "â™¾ï¸ğŸŒ¸", answer: "æ†æ˜¥" }, { emoji: "ğŸ¦", answer: "ç…å­" },
            { emoji: "ğŸŒº", answer: "ç‰¡ä¸¹" }, { emoji: "3ï¸âƒ£â­", answer: "ä¸‰æ˜Ÿ" }, { emoji: "ğŸ˜âš”ï¸", answer: "å¤§æ­¦" },
            { emoji: "7ï¸âƒ£ ğŸ§œ", answer: "ä¸ƒç¾" }
        ];

        function goTo(id) {
            document.querySelectorAll('.card > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // 1. å¾¹åº•é‡ç½®ä¸¦å›åˆ°é¦–é çš„åŠŸèƒ½
        function hardResetGame() {
            if(confirm("ç¢ºå®šçµæŸä¸¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿ")) {
                db.ref('/').remove().then(() => {
                    window.location.href = window.location.pathname + (isHost ? "?host=true" : "");
                });
            }
        }
        document.getElementById('btn-finish-reset').onclick = hardResetGame;

        document.getElementById('btn-join').onclick = function() {
            myName = document.getElementById('username').value.trim();
            if(!myName) return alert("è«‹è¼¸å…¥åå­—");
            if(isHost) {
                document.getElementById('host-global-tools').classList.remove('hidden');
                goTo('view-setup');
            } else {
                goTo('view-instruction');
            }
        };

        document.getElementById('btn-to-instruction').onclick = function() {
            goTo('view-instruction');
            document.getElementById('host-start-btn').classList.remove('hidden');
            document.getElementById('wait-player-msg').innerText = "æº–å‚™å¥½å¾Œè«‹æŒ‰ä¸‹æ–¹æŒ‰éˆ•é–‹å§‹";
        };

        document.getElementById('btn-real-start').onclick = function() {
            const count = parseInt(document.getElementById('q-count').value) || 10;
            const shuffled = questions.sort(() => 0.5 - Math.random()).slice(0, count);
            db.ref('game').set({ status: 'playing', qs: shuffled, idx: 0, winner: "", show: false });
        };

        db.ref('game').on('value', (snap) => {
            const game = snap.val();
            if(!game) return;
            if(game.status === 'playing') {
                goTo('view-game');
                const cur = game.qs[game.idx];
                document.getElementById('q-emoji').innerText = cur.emoji;
                document.getElementById('q-header').innerText = "ç¬¬ " + (game.idx + 1) + " é¡Œ";
                if(game.winner) {
                    document.getElementById('player-zone').classList.add('hidden');
                    document.getElementById('win-notification').classList.remove('hidden');
                    document.getElementById('win-player-name').innerText = game.winner;
                    if(isHost) {
                        document.getElementById('host-actions').classList.remove('hidden');
                        document.getElementById('btn-next').classList.toggle('hidden', !game.show);
                    }
                    if(game.show) {
                        document.getElementById('ans-reveal').classList.remove('hidden');
                        document.getElementById('correct-ans').innerText = cur.answer;
                    }
                } else {
                    if(!isHost) document.getElementById('player-zone').classList.remove('hidden');
                    document.getElementById('win-notification').classList.add('hidden');
                    document.getElementById('ans-reveal').classList.add('hidden');
                    document.getElementById('host-actions').classList.add('hidden');
                    document.getElementById('ans-input').value = "";
                }
            } else if(game.status === 'finished') {
                goTo('view-result');
                db.ref('players').once('value', pSnap => {
                    const ps = pSnap.val();
                    let list = [];
                    for(let k in ps) list.push({n: k, s: ps[k]});
                    list.sort((a,b) => b.s - a.s);
                    
                    // 2. æ¸²æŸ“åŒ…å«åæ¬¡çš„æ’è¡Œæ¦œ
                    let html = "";
                    list.forEach((p, index) => {
                        let rank = index + 1;
                        let rankDisplay = rank;
                        let rankClass = "rank-badge";
                        
                        if(rank === 1) { rankDisplay = "ğŸ¥‡"; rankClass += " top-1"; }
                        else if(rank === 2) { rankDisplay = "ğŸ¥ˆ"; rankClass += " top-2"; }
                        else if(rank === 3) { rankDisplay = "ğŸ¥‰"; rankClass += " top-3"; }
                        
                        html += `<tr class="lb-row">
                            <td class="lb-cell ${rankClass}">${rankDisplay}</td>
                            <td class="lb-cell" style="font-weight:bold;">${p.n}</td>
                            <td class="lb-cell">${p.s}</td>
                        </tr>`;
                    });
                    document.getElementById('leaderboard-body').innerHTML = html;
                });
            }
        });

        document.getElementById('btn-submit').onclick = function() {
            const val = document.getElementById('ans-input').value.trim();
            db.ref('game').once('value', (snap) => {
                const g = snap.val();
                if(val === g.qs[g.idx].answer && !g.winner) {
                    db.ref('game/winner').set(myName);
                    db.ref('players/' + myName).transaction(s => (s || 0) + 10);
                } else if(val) {
                    document.getElementById('feedback').innerText = "âŒ ä¸å°å–”ï¼";
                }
            });
        };

        document.getElementById('btn-reveal').onclick = () => db.ref('game/show').set(true);
        document.getElementById('btn-next').onclick = () => {
            db.ref('game').once('value', snap => {
                const g = snap.val();
                if(g.idx + 1 < g.qs.length) db.ref('game').update({idx: g.idx + 1, winner: "", show: false});
                else db.ref('game/status').set('finished');
            });
        };
    </script>
</body>
</html>