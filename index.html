<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji æ¶ç­”å¤§è³½</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #46178f; --accent: #ffa600; --danger: #ff4d4d; }
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', 'Microsoft JhengHei', sans-serif; background: var(--primary); color: white; margin: 0; padding-top: 50px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; text-align: center; }
        
        /* 2. æ´»å‹•åç¨±æ¨™é¡Œ */
        .event-title { font-size: 2.5rem; font-weight: 900; color: var(--accent); text-shadow: 3px 3px 0px #fff; margin-bottom: 20px; letter-spacing: 2px; }
        
        .card { background: white; color: #333; padding: 25px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); position: relative; }
        .hidden { display: none !important; }
        .emoji-box { font-size: 85px; margin: 15px 0; min-height: 130px; display: flex; justify-content: center; align-items: center; background: #f8f9fa; border-radius: 15px; }
        input { padding: 12px; font-size: 1.1rem; width: 80%; margin: 10px 0; border: 2px solid #ddd; border-radius: 8px; }
        button { background: var(--accent); color: white; border: none; padding: 12px 25px; font-size: 1.1rem; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-reset { background: var(--danger); font-size: 0.9rem; margin-top: 10px; }
        
        #debug-info { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: rgba(255,255,255,0.3); }
        .announcement { background: #d4edda; color: #155724; padding: 10px; border-radius: 10px; margin: 10px 0; font-weight: bold; border: 1px solid #c3e6cb; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        .lb-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="event-title">æ´»å‹•åç¨±</div>

    <div id="debug-info">Checking...</div>

    <div class="card">
        <div id="view-login">
            <h2>ğŸ‘‹ æ­¡è¿åƒåŠ ï¼</h2>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            <button id="btn-join">é€²å…¥éŠæˆ²</button>
        </div>

        <div id="view-waiting" class="hidden">
            <h3>æ‚¨å¥½ <span id="display-name"></span></h3>
            <p id="wait-msg">ç­‰å¾…ä¸»æŒäººé–‹å•Ÿé¡Œç›®...</p>
            <div id="host-ctrl" class="hidden" style="border-top: 2px solid #eee; margin-top: 15px; padding-top: 15px;">
                <button id="btn-start" style="background:#28a745;">ğŸš€ é–‹å§‹ç¬¬ä¸€é¡Œ</button><br>
                <button id="btn-hard-reset" class="btn-reset">âš ï¸ æ¸…ç©ºè³‡æ–™åº«ä¸¦é‡ä¾†</button>
            </div>
        </div>

        <div id="view-game" class="hidden">
            <div id="q-header" style="color:#888; font-weight: bold;"></div>
            <div id="q-emoji" class="emoji-box"></div>
            
            <div id="player-zone" class="hidden">
                <input type="text" id="ans-input" placeholder="ç­”æ¡ˆæ˜¯ï¼Ÿ">
                <button id="btn-submit">é€å‡ºæ¶ç­”</button>
                <p id="feedback" style="color:red; font-weight:bold;"></p>
            </div>

            <div id="win-notification" class="hidden">
                <div class="announcement">ğŸ‰ <span id="win-player-name"></span> æ¶ç­”æˆåŠŸï¼</div>
            </div>

            <div id="ans-reveal" class="hidden" style="background:#e7f3ff; padding:15px; border-radius:15px; margin-top:10px;">
                <h2 id="correct-ans" style="color:blue; margin:5px 0;"></h2>
                <p>é€™ä¸€é¡Œå¾—ä¸»æ˜¯ï¼š<span id="winner-name" style="font-weight:bold; color:green;"></span></p>
            </div>

            <div id="host-actions" class="hidden" style="margin-top:15px;">
                <button id="btn-reveal">æ­æ›‰ç­”æ¡ˆ</button>
                <button id="btn-next" class="hidden" style="background:var(--primary);">ä¸‹ä¸€é¡Œ â¡ï¸</button>
            </div>
        </div>

        <div id="view-result" class="hidden">
            <h2>ğŸ† æœ€çµ‚æ’è¡Œ</h2>
            <div id="leaderboard"></div>
            <button onclick="location.reload()" style="margin-top:20px;">å›é¦–é </button><br>
            <button id="btn-result-reset" class="btn-reset">â˜¢ï¸ å¾¹åº•é‡ç½®éŠæˆ²</button>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyAGKM7UL7hYCijHzS7lbPuHi-2M8Y9gZ7U",
            authDomain: "kahootclone-94620.firebaseapp.com",
            databaseURL: "https://kahootclone-94620-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kahootclone-94620",
            storageBucket: "kahootclone-94620.appspot.com",
            messagingSenderId: "173514871128",
            appId: "1:173514871128:web:6ca8ccb012ba5a49b7d52d"
        };

        firebase.initializeApp(config);
        const db = firebase.database();
        const isHost = window.location.search.includes('host=true');
        let myName = "";

        document.getElementById('debug-info').innerText = isHost ? "Mode: Host" : "Mode: Player";

        const questions = [
            { emoji: "ğŸ² â™¨ï¸", answer: "é¾æ½­" }, { emoji: "5ï¸âƒ£â›°ï¸", answer: "äº”å³°" }, { emoji: "ğŸ”Ÿ0ï¸âƒ£0ï¸âƒ£0ï¸âƒ£ğŸŒ¸", answer: "è¬è¯" },
            { emoji: "ğŸª‘æ©‹", answer: "æ¿æ©‹" }, { emoji: "ğŸ†•ğŸ ", answer: "æ–°å±‹" }, { emoji: "ğŸ†•ğŸ›’", answer: "æ–°åº—" },
            { emoji: "3ï¸âƒ£â›°ï¸", answer: "ä¸‰å³½" }, { emoji: "ğŸ¥‡â›°ï¸", answer: "é‡‘å±±" }, { emoji: "5ï¸âƒ£ğŸ¦´", answer: "äº”è‚¡" },
            { emoji: "7ï¸âƒ£ğŸš§", answer: "ä¸ƒå µ" }, { emoji: "ğŸ’â›°ï¸", answer: "å¯¶å±±" }, { emoji: "ğŸ¦ â™¨ï¸", answer: "ç…æ½­" },
            { emoji: "â¬‡ï¸âš“", answer: "å—æ¸¯" }, { emoji: "ğŸ˜ğŸ¤°", answer: "å¤§è‚š" }, { emoji: "ğŸ¦Œâš“", answer: "é¹¿æ¸¯" },
            { emoji: "2ï¸âƒ£ğŸŒ²", answer: "äºŒæ—" }, { emoji: "2ï¸âƒ£ğŸ’§", answer: "äºŒæ°´" }, { emoji: "ğŸ‹â›°ï¸", answer: "ç«¹å±±" },
            { emoji: "4ï¸âƒ£â™¨ï¸", answer: "å››æ¹–" }, { emoji: "ğŸ˜ğŸŒ²", answer: "å¤§æ—" }, { emoji: "ğŸ†•âš“", answer: "æ–°æ¸¯" },
            { emoji: "6ï¸âƒ£ğŸ¦µ", answer: "å…­è…³" }, { emoji: "ğŸ¦ŒğŸŒ±", answer: "é¹¿è‰" }, { emoji: "ğŸ§‚ğŸ’§", answer: "é¹½æ°´" },
            { emoji: "3ï¸âƒ£ğŸ§‘â€ğŸ¤â€ğŸ§‘", answer: "ä¸‰æ°‘" }, { emoji: "æ——ğŸ–Œï¸", answer: "æ——å±±" }, { emoji: "6ï¸âƒ£ğŸ¢", answer: "å…­é¾œ" },
            { emoji: "â¡ï¸âš“", answer: "æ±æ¸¯" }, { emoji: "â™¾ï¸ğŸŒ¸", answer: "æ†æ˜¥" }, { emoji: "ğŸ¦", answer: "ç…å­" },
            { emoji: "ğŸŒº", answer: "ç‰¡ä¸¹" }, { emoji: "3ï¸âƒ£â­", answer: "ä¸‰æ˜Ÿ" }, { emoji: "ğŸ˜âš”ï¸", answer: "å¤§æ­¦" },
            { emoji: "7ï¸âƒ£ ğŸ§œ", answer: "ä¸ƒç¾" }
        ];

        function goTo(id) {
            document.querySelectorAll('.card > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // 3. åˆªé™¤è³‡æ–™åº«é‚è¼¯
        function hardResetGame() {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰éŠæˆ²ç´€éŒ„èˆ‡åˆ†æ•¸ä¸¦é‡æ–°é–‹å§‹å—ï¼Ÿ")) {
                db.ref('/').remove().then(() => location.reload());
            }
        }
        document.getElementById('btn-hard-reset').onclick = hardResetGame;
        document.getElementById('btn-result-reset').onclick = hardResetGame;

        document.getElementById('btn-join').onclick = function() {
            myName = document.getElementById('username').value.trim();
            if(!myName) return alert("è«‹è¼¸å…¥åå­—");
            document.getElementById('display-name').innerText = myName;
            goTo('view-waiting');
            if(isHost) {
                document.getElementById('host-ctrl').classList.remove('hidden');
                document.getElementById('wait-msg').innerText = "ç®¡ç†å“¡æ‚¨å¥½ï¼Œè«‹æº–å‚™é–‹å§‹é¡Œç›®";
            }
        };

        document.getElementById('btn-start').onclick = function() {
            const shuffled = questions.sort(() => 0.5 - Math.random()).slice(0, 10);
            db.ref('game').set({ status: 'playing', qs: shuffled, idx: 0, winner: "", show: false });
        };

        db.ref('game').on('value', (snap) => {
            const game = snap.val();
            if(!game) {
                if(myName) goTo('view-waiting');
                return;
            }
            if(game.status === 'playing') {
                goTo('view-game');
                const cur = game.qs[game.idx];
                document.getElementById('q-emoji').innerText = cur.emoji;
                document.getElementById('q-header').innerText = "ç¬¬ " + (game.idx + 1) + " é¡Œ";

                if(game.winner) {
                    // 1. æœ‰äººç­”å°æ™‚çš„è™•ç†
                    document.getElementById('player-zone').classList.add('hidden');
                    document.getElementById('win-notification').classList.remove('hidden');
                    document.getElementById('win-player-name').innerText = game.winner;
                    
                    if(isHost) {
                        document.getElementById('host-actions').classList.remove('hidden');
                        document.getElementById('btn-next').classList.toggle('hidden', !game.show);
                    }
                    if(game.show) {
                        document.getElementById('ans-reveal').classList.remove('hidden');
                        document.getElementById('correct-ans').innerText = "ç­”æ¡ˆï¼š" + cur.answer;
                        document.getElementById('winner-name').innerText = game.winner;
                    }
                } else {
                    // 1. æ¶ç­”ä¸­ï¼šä¸»æŒäººä¸é¡¯ç¤ºè¼¸å…¥æ¡†
                    if(!isHost) {
                        document.getElementById('player-zone').classList.remove('hidden');
                    }
                    document.getElementById('win-notification').classList.add('hidden');
                    document.getElementById('ans-reveal').classList.add('hidden');
                    document.getElementById('host-actions').classList.add('hidden');
                    document.getElementById('ans-input').value = "";
                    document.getElementById('feedback').innerText = "";
                }
            } else if(game.status === 'finished') {
                goTo('view-result');
                db.ref('players').once('value', pSnap => {
                    const ps = pSnap.val();
                    let list = [];
                    for(let k in ps) list.push({n: k, s: ps[k]});
                    list.sort((a,b) => b.s - a.s);
                    document.getElementById('leaderboard').innerHTML = list.map(p => 
                        `<div class="lb-item"><span>${p.n}</span><span>${p.s} åˆ†</span></div>`
                    ).join('');
                });
            }
        });

        document.getElementById('btn-submit').onclick = function() {
            const val = document.getElementById('ans-input').value.trim();
            db.ref('game').once('value', (snap) => {
                const g = snap.val();
                if(val === g.qs[g.idx].answer && !g.winner) {
                    db.ref('game/winner').set(myName);
                    db.ref('players/' + myName).transaction(s => (s || 0) + 10);
                } else {
                    document.getElementById('feedback').innerText = "âŒ ä¸å°å–”ï¼Œå†çŒœçŒœï¼";
                }
            });
        };

        document.getElementById('btn-reveal').onclick = () => db.ref('game/show').set(true);
        document.getElementById('btn-next').onclick = () => {
            db.ref('game').once('value', snap => {
                const g = snap.val();
                if(g.idx + 1 < g.qs.length) {
                    db.ref('game').update({idx: g.idx + 1, winner: "", show: false});
                } else {
                    db.ref('game/status').set('finished');
                }
            });
        };
    </script>
</body>
</html>